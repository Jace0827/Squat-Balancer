<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2GRASS</title>

    <style>
        body {
            background-color: #808080;
        }

        #squatAssist {
            font-size: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .lefted-container label[for="howToUse"] {
            font-size: 10px;
        }

        .centered-container label[for="countdownInput"] {
            font-size: 15px;
        }

        .lefted-container {
            text-align: left;
            margin: 20px 0;
            margin-left: 20px;
            margin-right: 20px;
        }

        .centered-container #canvas {
            display: none;
        }

        .centered-container {
            text-align: center;
            margin: 10px 0;
        }

        #countdownDisplay {
            font-size: 60px;
        }

        #count-container {
            font-size: 40px;
        }

        #countdownInput {
            font-size: 10px;
            padding: 5px 10px;
            background-color: white;
            color: black;
            border: default;
            border-radius: 5px;
            cursor: pointer;
        }

        .button-container {
            text-align: center;
            margin: 20px 0;
        }

        /* Style for the initialize button */
        #initButton {
            font-size: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            /* Make border rounded */
            cursor: pointer;
        }

        #initButton:hover {
            background-color: #3c8e40;
            /* Change background color on mouse hover */
        }

        .custom-font-size-for-init {
            font-size: 30px;
        }

        #startButton {
            font-size: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startButton:hover {
            background-color: #3c8e40;
        }

        #howToUseButton {
            font-size: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #howToUseButton:hover {
            background-color: #3c8e40;
        }

        #goButton {
            font-size: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #goButton:hover {
            background-color: #3c8e40;
        }

        #stopButton {
            font-size: 20px;
            padding: 10px 20px;
            background-color: #FF431B;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #stopButton:hover {
            background-color: #ee4019;
        }
    </style>
</head>

<body>
    <div id="squatAssist">Squat Assist</div>

    <div class="centered-container">
        <canvas id="canvas"></canvas>
    </div>

    <div class="centered-container">
        <div id="count-container"></div>
    </div>

    <div class="centered-container">
        <div id="count-container"></div>
    </div>

    <!-- Countdown Section, initially hidden -->
    <div class="centered-container" id="countdownInputSection" style="display:block;">
        <label for="countdownInput">Countdown (seconds): </label>
        <input type="number" id="countdownInput" value="1" min="1" max="60">
    </div>

    <div class="button-container">
        <button type="button" id="startButton" onclick="startExercise()" style="display: none;">Start</button>
        <button type="button" id="howToUseButton" onclick="howToUseStep1()" style="display: none;">How to Use</button>
        <button type="button" id="goButton" onclick="go()" style="display: none;">Go</button>
        <button type="button" id="stopButton" onclick="stop()" style="display: none;">Stop</button>
    </div>

    <!-- How to Use Step 1: Initialize Your Position -->
    <div id="howToUseStep1Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 1: Initialize Your Position</h2>
        <img src="imgae/set-up-the-countdown.png" alt="Setup Example" style="width: 300px; margin-bottom: 20px;" />
        <p>Enter the number of seconds you need to get ready and into position before starting the initialization
            process.
            This will start a countdown timer allowing you to prepare before the initialization of the four key postures
            begins.</p>
        <p>Example: If you need 30 seconds to prepare, enter "30" in the countdown box and press "Start". This process
            will help in calibrating the system for accurate posture recognition.</p>
        <button type="button" id="howToUseButton" onclick="howToUseStep2()">Step 1/6</button>
    </div>


    <!-- How to Use Step 2: Squat Position Initialization -->
    <div id="howToUseStep2Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 2: Squat Position Initialization</h2>
        <img src="imgae/squat-positioning.png" alt="Squat Position Initialization Example"
            style="width: 300px; margin-bottom: 20px;" />
        <p>For the first posture initialization, focus on the squat position. Ensure you are fully visible in the camera
            frame. Adjust your position so that when you are at the lowest point of your squat, you fill the camera
            frame as much as possible.</p>
        <p>The graph will illustrate this by positioning the red dot at the bottom center when you're in the correct
            squat position.
        </p>
        <button type="button" id="howToUseButton" onclick="howToUseStep3()">Step 2/6</button>
    </div>

    <!-- How to Use Step 3: Standing Posture Initialization -->
    <div id="howToUseStep3Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 3: Standing Posture Initialization</h2>
        <img src="imgae/standing-positioning.png" alt="Standing Position Initialization Example"
            style="width: 300px; margin-bottom: 20px;" />
        <p>For the standing posture initialization, ensure that only your lower body is visible in the camera frame.</p>
        <p>The graph will show the red dot at the top center to indicate the standing posture initialization. </p>
        <button type="button" id="howToUseButton" onclick="howToUseStep4()">Step 3/6</button>
    </div>

    <!-- How to Use Step 4: Squat Left and Right Initialization -->
    <div id="howToUseStep4Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 4: Activation of the "Go" Button</h2>
        <img src="imgae/squat-left-and-right.png" alt="Standing Position Initialization Example"
            style="width: 300px; margin-bottom: 20px;" />
        <p>With the initial posture initializations for squat, standing, and seated weight shifts to the left/right
            completed, the "Go" button will now become active. This indicates that the system is calibrated and ready to
            track your workout.</p>
        <p>Pressing "Go" will commence the exercise session. Make sure you're positioned correctly in front of the
            camera as you start.</p>
        <button type="button" id="howToUseButton" onclick="howToUseStep5()">Step 4/6</button>
    </div>

    <!-- How to Use Step 5: Starting the Exercise and Using the "Stop" Button -->
    <div id="howToUseStep5Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 5: Starting the Exercise and Using the "Stop" Button</h2>
        <img src="imgae/go.png" alt="Standing Position Initialization Example"
            style="width: 300px; margin-bottom: 20px;" />
        <p>Upon pressing "Go", your exercise session starts. The system will count each squat as you perform it. When
            you squat and then stand up, each successful movement will be counted.</p>
        <p>If you perform a squat with a weight shift to the left or right, an audio alert will specify the direction
            ("Left" or "Right") instead of incrementing the squat count. This helps you maintain the correct form and
            balance during your workout.</p>
        <p>The "Stop" button becomes active as soon as you press "Go". You can press "Stop" at any time to pause the
            session or to end your workout. Upon pressing "Stop", the counting will pause, and you can either take a
            break or conclude your exercise routine.</p>
        <button type="button" id="howToUseButton" onclick="howToUseStep6()">Step 5/6</button>
    </div>

    <!-- How to Use Step 6: Stopping and Resetting the Session -->
    <div id="howToUseStep6Container" style="display:none; text-align: center; margin-top: 20px;">
        <h2>Step 6: Stopping and Resetting the Session</h2>
        <img src="imgae/stop.png" alt="Standing Position Initialization Example"
            style="width: 300px; margin-bottom: 20px;" />
        <p>Pressing the "Stop" button will end your current session, resetting the exercise count and pausing any
            ongoing activities. This allows you to take a break or conclude your workout as needed.</p>
        <p>After stopping, you can choose to restart your workout by initiating the "Go" button again, which will be
            reactivated, or you can go back to the first step to review the instructions or adjust your setup.</p>

        <div class="centered-container" id="countdownInputSection" style="display:block;">
            <label for="countdownInput">Countdown (seconds): </label>
            <input type="number" id="countdownInput" value="5" min="1" max="60">
        </div>

        <div class="button-container">
            <button type="button" id="startButton" onclick="startExercise()"
                style="display: inline-block;">Start</button>
        </div>
    </div>


    <div id="twoDimensionalGraphContainer"
        style="position: relative; width: 200px; height: 200px; margin: 20px auto; display: none;">
        <img id="twoDimensionalGraph" src="imgae/graph-image.png" style="width: 200px; height: 200px;" />
        <div id="graphPoint"
            style="position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: red; left: 50%; top: 50%; transform: translate(-50%, -50%);">
        </div>
    </div>

    <div class="centered-container custom-font-size-for-init" id="squat" style="display:none;">
        <p>Squat</p>
    </div>

    <div class="centered-container custom-font-size-for-init" id="stand" style="display:none;">
        <p>Stand</p>
    </div>

    <div class="centered-container custom-font-size-for-init" id="squatLeft" style="display:none;">
        <p>Squat Left</p>
    </div>

    <div class="centered-container custom-font-size-for-init" id="squatRight" style="display:none;">
        <p>Squat Right</p>
    </div>
    <div class="centered-container custom-font-size-for-init" id="testText" style="display:none;">
        <p>OKAY</p>
    </div>

    <div class="centered-container" id="countdownDisplay"></div>

    <div id="countdownDisplay" style="display: none;">3</div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    <script src="howToUse.js"></script>
    <script src="initializePose.js"></script>
    <script type="text/javascript">
        // More API functions here:
        // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

        // the link to your model provided by Teachable Machine export panel
        const URL = "./my-pose-model/";
        let model, webcam, ctx, labelContainer, maxPredictions;
        // Mark whether each posture is accurately recognized
        let posesInit = [false, false, false, false];
        // Mark if ready to exercise once all postures are recognized
        let ready = false;
        let started = false;
        // Track the start time when each posture exceeds 90% recognition
        let above90StartTimes = [0, 0, 0, 0];
        // Output audio when true
        let sitLeft = false;
        let sitRight = false;
        let countdownDone = false;
        let showPredictions = false;
        var status = "none";
        var count = 0;
        var countdown;

        // 0~1, more strict when 0
        var standSensitivity = 0.9;
        var squatSensitivity = 0.9;
        var sitLeftSensitivity = 0.9;
        var sitRightSensitivity = 0.9;

        const requiredProbability = 0.9;
        const poseNames = ['squat', 'stand', 'squatLeft', 'squatRight'];
        let poseIndex = 0;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            countdown = document.getElementById('countdownInput').value;

            // load the model and metadata
            // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
            // Note: the pose library adds a tmPose object to your window (window.tmPose)
            model = await tmPose.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Convenience function to setup a webcam
            const size = 200;
            const flip = true; // whether to flip the webcam
            webcam = new tmPose.Webcam(size, size, flip); // width, height, flip
            await webcam.setup(); // request access to the webcam
            await webcam.play();
            window.requestAnimationFrame(loop);

            // append/get elements to the DOM
            const canvas = document.getElementById("canvas");
            canvas.width = size; canvas.height = size;
            ctx = canvas.getContext("2d");
            labelContainer = document.getElementById("count-container");
            for (let i = 0; i < maxPredictions; i++) { // and class labels
                labelContainer.appendChild(document.createElement("div"));
                labelContainer.childNodes[i].style.fontSize = '30px';
            }
            // center the camera
            document.getElementById('canvas').style.display = 'inline-block';
        }

        async function loop(timestamp) {
            webcam.update(); // update the webcam frame
            const prediction = await predict();
            window.requestAnimationFrame(loop);
            if (started) {
                setTimeout(() => {
                    updatePosesInit(prediction, timestamp);
                    countdownDone = true;
                }, countdown * 1000);

            } else {
                updatePosesInit(prediction, timestamp);
            }
        }

        async function predict() {
            // Prediction #1: run input through posenet
            // estimatePose can take in an image, video or canvas html element
            const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
            // Prediction 2: run input through teachable machine classification model
            const prediction = await model.predict(posenetOutput);

            if (countdownDone) {
                document.getElementById('twoDimensionalGraphContainer').style.display = 'block';
                updateTwoDimensionalGraph(prediction);
            }

            //pose weight visualization, 
            //Commenting Out
            // for (let i = 0; i < maxPredictions; i++) {
            //     const classPrediction =
            //         prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            //     labelContainer.childNodes[i].innerHTML = classPrediction;//pose parameter
            // }

            // finally draw the poses
            drawPose(pose);
            return prediction;

        }

        function drawPose(pose) {
            if (webcam.canvas) {
                ctx.drawImage(webcam.canvas, 0, 0);
                // draw the keypoints and skeleton
                if (pose) {
                    const minPartConfidence = 0.5;
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                }
            }
        }
        function updatePosesInit(prediction, timestamp) {
            if (countdownDone) {
                if (poseIndex < maxPredictions) {
                    initializePoseByIndex(poseIndex, prediction, timestamp);
                } else {
                    document.getElementById('startButton').style.display = 'block';
                }
            }
        }

        window.onload = async () => {
            await init();
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('howToUseButton').style.display = 'inline-block';
        };

        // todo: implement go and stop feature

        // Inside the startExercise function, it only makes the countdownInputSection visible.
        function startExercise() {
            started = true;
            console.log('Countdown started');
            document.getElementById('countdownInputSection').style.display = 'none';
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('howToUseButton').style.display = 'none';
            document.getElementById('howToUseStep6Container').style.display = 'none';

            // Get the user-input countdown time from countdownInput element in real-time.
            let countdown = parseInt(document.getElementById('countdownInput').value, 10); // 문자열을 숫자로 변환

            let countdownTimer = countdown;
            document.getElementById('countdownDisplay').style.display = 'block';
            document.getElementById('countdownDisplay').innerHTML = countdownTimer;
            let countdownInterval = setInterval(function () {
                countdownTimer--;
                document.getElementById('countdownDisplay').innerHTML = countdownTimer;

                if (countdownTimer <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownDisplay').style.display = 'none';
                    countdownDone = true; // Set countdownDone to true when countdown ends
                    // Actions to perform after countdown ends
                    // For example: start motion detection
                }
            }, 1000);
        }

        // Adding an event listener for clicking the countdownStartButton to call the startCountdown function.
        document.getElementById('countdownStartButton').addEventListener('click', startCountdown);

        function startCountdown() {
            console.log('Countdown started');
            document.getElementById('countdownInputSection').style.display = 'none';

            // Get the user-input countdown time from countdownInput element in real-time.
            let countdown = parseInt(document.getElementById('countdownInput').value, 10);

            let countdownTimer = countdown;
            document.getElementById('countdownDisplay').style.display = 'block';
            document.getElementById('countdownDisplay').innerHTML = countdownTimer;
            let countdownInterval = setInterval(function () {
                countdownTimer--;
                document.getElementById('countdownDisplay').innerHTML = countdownTimer;

                if (countdownTimer <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownDisplay').style.display = 'none';
                    countdownDone = true; 
                }
            }, 1000);
        }


        window.onload = async () => {
            await init();
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('howToUseButton').style.display = 'inline-block';
        };


        function updateTwoDimensionalGraph(prediction) {
            const containerWidth = 200; // Width of the 2D graph container
            const containerHeight = 200; // Height of the 2D graph containe

            // Calculate the X position based on the difference in probabilities between classes 2(left) and 3(right)
            const xPosition = (prediction[3].probability - prediction[2].probability) * containerWidth / 2;

            // Calculate the Y position based on the difference in probabilities between classes 0(squat) and 1(stand), and the activation of classes 2 or 3
            const yBasePosition = (prediction[0].probability - prediction[1].probability + prediction[3].probability + prediction[2].probability) * containerHeight / 2;
            const yPosition = Math.max(yBasePosition, -containerHeight / 2); // 최하단을 넘지 않도록 제한

            // Update the position of the point
            document.getElementById('graphPoint').style.left = `calc(50% + ${xPosition}px)`;
            document.getElementById('graphPoint').style.top = `calc(50% + ${yPosition}px)`;
        }
    </script>


</body>

</html>